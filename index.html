
<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PRIORIDADES | CLOUD</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Saira:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              saira: ['Saira', 'sans-serif'],
            },
            colors: {
              neon: {
                red: '#ff003c',
                green: '#00ff41',
                yellow: '#fcee0a',
                blue: '#0afcff',
                gray: '#7a8296',
                dark: '#050a14',
                panel: '#0a1220',
              }
            },
            animation: {
                'fade-in-down': 'fadeInDown 0.3s ease-out',
                'shine': 'shine 1s forwards',
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
                fadeInDown: {
                    '0%': { opacity: '0', transform: 'translateY(-10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                shine: {
                    '100%': { transform: 'translateX(100%) skewX(12deg)' }
                }
            }
          }
        }
      }
    </script>

    <style>
      body {
        background-color: #050a14;
        color: #e2e8f0;
        font-family: 'Saira', sans-serif;
        overflow-x: hidden;
        overscroll-behavior-y: none;
      }
      
      .bg-cyber {
        background-image: 
          linear-gradient(rgba(10, 252, 255, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(10, 252, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        background-position: center top;
      }
      
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0a1220; }
      ::-webkit-scrollbar-thumb { background: #0afcff; border-radius: 2px; }
      
      .hide-scrollbar::-webkit-scrollbar { display: none; }
      .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      .clip-path-slant {
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      }

      .glass-panel {
        background: rgba(10, 18, 32, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(10, 252, 255, 0.1);
      }

      /* Loading Spinner */
      .loader {
        width: 48px;
        height: 48px;
        border: 3px solid #0afcff;
        border-radius: 50%;
        display: inline-block;
        position: relative;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }
      .loader::after {
        content: '';  
        box-sizing: border-box;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid;
        border-color: #ff003c transparent;
      }
      @keyframes rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- 
      CRITICAL: IMPORT MAP 
      Ensures all libraries use the EXACT SAME version of React (18.2.0).
    -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@dnd-kit/core": "https://esm.sh/@dnd-kit/core@6.0.8?deps=react@18.2.0,react-dom@18.2.0",
    "@dnd-kit/sortable": "https://esm.sh/@dnd-kit/sortable@7.0.2?deps=react@18.2.0,react-dom@18.2.0,@dnd-kit/core@6.0.8",
    "@dnd-kit/utilities": "https://esm.sh/@dnd-kit/utilities@3.2.1?deps=react@18.2.0",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "clsx": "https://esm.sh/clsx@2.0.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root">
        <!-- Loading State -->
        <div class="min-h-screen bg-black flex items-center justify-center">
            <div class="text-center">
                <span class="loader mb-4"></span>
                <p class="text-[#0afcff] font-saira tracking-widest animate-pulse">INITIALIZING CORE...</p>
            </div>
        </div>
    </div>

    <!-- Global Error Handler -->
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        console.error("Global Error:", message, error);
      };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            DndContext, DragOverlay, pointerWithin, KeyboardSensor, PointerSensor, useSensor, useSensors
        } from '@dnd-kit/core';
        import { 
            SortableContext, verticalListSortingStrategy, sortableKeyboardCoordinates, arrayMove, useSortable
        } from '@dnd-kit/sortable';
        import { CSS } from '@dnd-kit/utilities';
        import { useDroppable } from '@dnd-kit/core';
        import { 
            AlertCircle, Calendar, Users, Trash2, Plus, Check, GripVertical, 
            Activity, CheckCircle2, AlertTriangle, Star, Download, 
            LogOut, LayoutGrid, Share2, Menu, X, Shield, UserPlus
        } from 'lucide-react';
        import { clsx } from 'clsx';
        
        // FIREBASE IMPORTS
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, query, where, onSnapshot, 
            doc, updateDoc, deleteDoc, orderBy, serverTimestamp, arrayUnion
        } from 'firebase/firestore';

        console.log("Modules loaded successfully");

        // ==========================================
        // ⚠️ CONFIGURACIÓN DE FIREBASE REQUERIDA ⚠️
        // ==========================================
        // 1. Ve a https://console.firebase.google.com/
        // 2. Crea un proyecto > Agrega una app Web > Copia el config
        // 3. REEMPLAZA las comillas vacías con tus valores:
        const firebaseConfig = {
            apiKey: "AIzaSyDqabjCAi3Gjbef4tzWOq3RZpxwMrjGkPg",
            authDomain: "app-prioridades-29877.firebaseapp.com",
            projectId: "app-prioridades-29877",
            storageBucket: "app-prioridades-29877.firebasestorage.app",
            messagingSenderId: "790357210714",
            appId: "1:790357210714:web:4a96e5b854d655e4210a63",
            measurementId: "G-XF7QG1CF42"
        };

        // --- INITIALIZATION ---
        let app, auth, db;
        let isFirebaseConfigured = false;
        let configErrorType = null;

        // Validation to prevent cryptic Google errors
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "") {
            configErrorType = "missing_key";
        } else if (!firebaseConfig.authDomain || firebaseConfig.authDomain === "") {
             configErrorType = "missing_domain";
        } else {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseConfigured = true;
                console.log("Firebase initialized successfully");
            } catch (e) {
                console.error("Firebase Init Error:", e);
                configErrorType = "init_failed";
            }
        }

        // --- CONSTANTS ---
        const QuadrantId = {
            Do: 'do',
            Plan: 'plan',
            Delegate: 'delegate',
            Delete: 'delete',
        };

        const QUADRANTS = [
            { id: QuadrantId.Do, title: 'HACER', subtitle: 'URGENTE', color: 'bg-neon-red', borderColor: 'border-neon-red', textColor: 'text-neon-red', Icon: AlertCircle },
            { id: QuadrantId.Plan, title: 'PLANIFICAR', subtitle: 'AGENDAR', color: 'bg-neon-green', borderColor: 'border-neon-green', textColor: 'text-neon-green', Icon: Calendar },
            { id: QuadrantId.Delegate, title: 'DELEGAR', subtitle: 'A OTROS', color: 'bg-neon-yellow', borderColor: 'border-neon-yellow', textColor: 'text-neon-yellow', Icon: Users },
            { id: QuadrantId.Delete, title: 'ELIMINAR', subtitle: 'BORRAR', color: 'bg-neon-gray', borderColor: 'border-neon-gray', textColor: 'text-neon-gray', Icon: Trash2 },
        ];

        // --- COMPONENTS ---

        const CyberButton = ({ children, className, variant = 'primary', fullWidth = false, ...props }) => {
            const baseStyles = "font-saira font-bold uppercase tracking-wider transition-all duration-200 relative overflow-hidden group flex items-center justify-center gap-2 py-2 px-4 clip-path-slant";
            const variants = {
                primary: "bg-neon-blue/10 border border-neon-blue text-neon-blue hover:bg-neon-blue hover:text-neon-dark hover:shadow-neon-blue",
                danger: "bg-neon-red/10 border border-neon-red text-neon-red hover:bg-neon-red hover:text-neon-dark hover:shadow-neon-red",
                success: "bg-neon-green/10 border border-neon-green text-neon-green hover:bg-neon-green hover:text-neon-dark hover:shadow-neon-green",
                ghost: "bg-transparent border border-transparent text-slate-400 hover:text-white hover:bg-white/5",
            };
            return (
                <button className={clsx(baseStyles, variants[variant], fullWidth ? "w-full" : "w-auto", className)} {...props}>
                    {children}
                    <div className="absolute inset-0 w-full h-full bg-white/20 translate-x-[-100%] skew-x-12 group-hover:animate-shine pointer-events-none" />
                </button>
            );
        };

        const InstallPrompt = () => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isVisible, setIsVisible] = useState(false);
            useEffect(() => {
                const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); setIsVisible(true); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);
            const handleInstall = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                setDeferredPrompt(null); setIsVisible(false);
            };
            if (!isVisible) return null;
            return (
                <div className="fixed bottom-24 right-4 z-50">
                    <CyberButton onClick={handleInstall} className="shadow-[0_0_15px_rgba(10,252,255,0.5)] text-xs">
                        <Download size={16} /> INSTALAR
                    </CyberButton>
                </div>
            );
        };

        // --- TASK CARD ---
        const TaskCard = ({ task, onToggle, onDelete, isOverlay = false }) => {
            const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: task.id, data: { task } });
            const style = { transform: CSS.Transform.toString(transform), transition, opacity: isDragging ? 0.5 : 1 };
            const config = QUADRANTS.find(q => q.id === task.quadrant) || QUADRANTS[0];

            return (
                <div ref={setNodeRef} style={style} className={`relative group flex items-center gap-3 p-3 mb-3 bg-neon-dark/80 border-l-4 ${task.completed ? 'border-slate-600 opacity-60 grayscale' : config.borderColor} ${isOverlay ? 'shadow-2xl scale-105 z-50 border' : 'border-y border-r border-slate-800/50'} hover:bg-white/5 touch-manipulation`}>
                    <div {...attributes} {...listeners} className="cursor-grab active:cursor-grabbing text-slate-600 hover:text-white touch-none p-4 -ml-2">
                        <GripVertical size={24} />
                    </div>
                    <div className="flex-1 min-w-0 py-1">
                        <p className={`font-saira font-medium text-sm ${task.completed ? 'line-through text-slate-500' : 'text-slate-200'}`}>{task.content}</p>
                    </div>
                    <div className="flex gap-1">
                        <button onClick={() => onToggle(task.id, !task.completed)} className={`p-2 rounded ${task.completed ? 'text-neon-green' : 'text-slate-500 hover:text-neon-green'}`}><Check size={20} /></button>
                        <button onClick={() => onDelete(task.id)} className="p-2 rounded text-slate-500 hover:text-neon-red"><Trash2 size={20} /></button>
                    </div>
                </div>
            );
        };

        // --- QUADRANT LIST ---
        const QuadrantList = ({ id, tasks, onToggle, onDelete }) => {
            const { setNodeRef, isOver } = useDroppable({ id });
            const config = QUADRANTS.find(q => q.id === id);
            const myTasks = tasks.filter(t => t.quadrant === id);

            return (
                <div ref={setNodeRef} className="h-full w-full md:h-auto">
                    <div className={`flex flex-col rounded-lg overflow-hidden h-full bg-neon-panel border border-slate-800/50 shadow-lg transition-colors ${isOver ? 'bg-white/5 ring-2 ring-inset ' + config.textColor : ''}`}>
                        <div className={`flex items-center justify-between p-4 border-b ${config.borderColor} bg-black/20`}>
                            <div className="flex items-center gap-2">
                                <div className={config.textColor}><config.Icon className="w-5 h-5" /></div>
                                <div>
                                    <h3 className={`font-saira font-black text-xl leading-none ${config.textColor}`}>{config.title}</h3>
                                    <p className="text-xs text-slate-400 font-semibold uppercase tracking-widest">{config.subtitle}</p>
                                </div>
                            </div>
                            <span className={`font-mono text-xs px-2 py-1 rounded bg-black/40 border border-slate-800 ${config.textColor}`}>{myTasks.length}</span>
                        </div>
                        <div className="flex-1 p-2 min-h-[200px] overflow-y-auto custom-scrollbar">
                            <SortableContext id={id} items={myTasks.map(t => t.id)} strategy={verticalListSortingStrategy}>
                                {myTasks.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-700 p-8 text-center">
                                        <config.Icon className="w-5 h-5 mb-2 opacity-20" />
                                        <p className="text-sm uppercase">Vacío</p>
                                    </div>
                                ) : (
                                    myTasks.map(task => <TaskCard key={task.id} task={task} onToggle={onToggle} onDelete={onDelete} />)
                                )}
                            </SortableContext>
                        </div>
                    </div>
                </div>
            );
        };

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen bg-cyber flex flex-col items-center justify-center p-6 text-center">
                <div className="glass-panel p-8 rounded-2xl max-w-md w-full shadow-[0_0_40px_rgba(10,252,255,0.1)] border-neon-blue/30">
                    <h1 className="text-5xl font-saira font-black text-transparent bg-clip-text bg-gradient-to-r from-neon-blue to-neon-green mb-2">PRIORIDADES</h1>
                    <p className="text-slate-400 font-mono tracking-widest mb-8">SISTEMA DE GESTIÓN CLOUD</p>
                    
                    <div className="mb-8 p-4 border border-neon-red/30 bg-neon-red/5 rounded text-left">
                        <h3 className="text-neon-red font-bold flex items-center gap-2 mb-2"><Shield size={16} /> ACCESO REQUERIDO</h3>
                        <p className="text-sm text-slate-400">Este sistema utiliza almacenamiento en la nube cifrado. Debes autenticarte para acceder a tus tableros privados y compartidos.</p>
                    </div>

                    <CyberButton onClick={onLogin} fullWidth className="py-4 text-lg">
                        <span className="mr-2">G</span> ENTRAR CON GOOGLE
                    </CyberButton>
                </div>
            </div>
        );

        // --- CONFIG ERROR SCREEN ---
        const ConfigErrorScreen = ({ type }) => {
            let title = "ERROR DE CONFIGURACIÓN";
            let msg = "Falta información en el archivo index.html";
            
            if (type === "missing_domain") {
                 msg = "Falta el 'authDomain' en firebaseConfig. Esto causa el Error 400 de Google. Copia todo el bloque de configuración de la consola de Firebase.";
            } else if (type === "missing_key") {
                 msg = "Falta la 'apiKey'. Debes pegar tus credenciales de Firebase en la variable firebaseConfig del archivo HTML.";
            }

            return (
                <div className="min-h-screen bg-black text-neon-red flex flex-col items-center justify-center p-8 text-center font-mono">
                    <AlertTriangle size={64} className="mb-4 animate-pulse" />
                    <h1 className="text-2xl font-bold mb-4">{title}</h1>
                    <p className="max-w-lg mb-6 text-slate-300">{msg}</p>
                    <div className="bg-slate-900 p-4 rounded text-left text-xs text-green-400 overflow-x-auto w-full max-w-lg border border-slate-700">
                        const firebaseConfig = &#123;<br/>
                        &nbsp;&nbsp;apiKey: "PEGAR_AQUI",<br/>
                        &nbsp;&nbsp;authDomain: "TU_PROYECTO.firebaseapp.com",<br/>
                        &nbsp;&nbsp;...<br/>
                        &#125;;
                    </div>
                </div>
            );
        };

        // --- SIDEBAR & MODALS ---
        const CreateBoardModal = ({ onClose, onCreate }) => {
            const [title, setTitle] = useState('');
            return (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="glass-panel p-6 rounded-xl w-full max-w-sm border-neon-blue">
                        <h2 className="text-xl font-bold text-white mb-4">NUEVO TABLERO</h2>
                        <input autoFocus type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="Ej: Negocio, Casa..." className="w-full bg-black/50 border border-slate-600 p-3 text-white mb-4 focus:border-neon-blue outline-none" />
                        <div className="flex gap-2">
                            <CyberButton variant="ghost" onClick={onClose} className="flex-1">Cancelar</CyberButton>
                            <CyberButton onClick={() => onCreate(title)} disabled={!title.trim()} className="flex-1">Crear</CyberButton>
                        </div>
                    </div>
                </div>
            );
        };

        const ShareBoardModal = ({ onClose, onShare, currentMembers }) => {
            const [email, setEmail] = useState('');
            return (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="glass-panel p-6 rounded-xl w-full max-w-sm border-neon-yellow">
                        <h2 className="text-xl font-bold text-neon-yellow mb-4 flex items-center gap-2"><Users /> COMPARTIR TABLERO</h2>
                        <p className="text-xs text-slate-400 mb-4">Agrega el email de la persona. El tablero aparecerá en su lista automáticamente.</p>
                        
                        <div className="flex gap-2 mb-6">
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="usuario@email.com" className="flex-1 bg-black/50 border border-slate-600 p-3 text-white focus:border-neon-yellow outline-none" />
                            <CyberButton onClick={() => {onShare(email); setEmail('');}} disabled={!email.trim()} variant="success"><UserPlus size={20}/></CyberButton>
                        </div>

                        <div className="mb-4">
                            <h4 className="text-xs font-bold text-slate-500 mb-2">MIEMBROS ACTUALES:</h4>
                            <div className="space-y-1">
                                {currentMembers?.map((m, i) => (
                                    <div key={i} className="text-sm text-slate-300 bg-white/5 p-2 rounded flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-neon-green"></div>
                                        {m}
                                    </div>
                                ))}
                                {(!currentMembers || currentMembers.length === 0) && <span className="text-slate-600 text-xs">Solo tú tienes acceso.</span>}
                            </div>
                        </div>

                        <CyberButton variant="ghost" onClick={onClose} fullWidth>Cerrar</CyberButton>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, onClose, user, boards, currentBoardId, onSelectBoard, onCreateBoard, onLogout }) => {
            return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden" onClick={onClose} />}
                    <div className={`fixed top-0 left-0 h-full w-72 bg-[#080c14] border-r border-slate-800 z-50 transform transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-neon-blue">TABLEROS</h2>
                            <button onClick={onClose} className="md:hidden text-slate-400"><X /></button>
                        </div>
                        
                        <div className="p-4 overflow-y-auto h-[calc(100%-140px)]">
                            <div className="mb-6">
                                <h3 className="text-xs font-bold text-slate-500 mb-3 px-2 uppercase tracking-wider">Mis Tableros</h3>
                                <div className="space-y-1">
                                    {boards.filter(b => b.ownerId === user.uid).map(board => (
                                        <button 
                                            key={board.id}
                                            onClick={() => { onSelectBoard(board.id); onClose(); }}
                                            className={`w-full text-left p-3 rounded-lg flex items-center gap-3 transition-all ${currentBoardId === board.id ? 'bg-neon-blue/20 text-neon-blue border border-neon-blue/50' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}
                                        >
                                            <LayoutGrid size={16} />
                                            <span className="font-bold truncate">{board.title}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h3 className="text-xs font-bold text-slate-500 mb-3 px-2 uppercase tracking-wider">Compartidos</h3>
                                <div className="space-y-1">
                                    {boards.filter(b => b.ownerId !== user.uid).map(board => (
                                        <button 
                                            key={board.id}
                                            onClick={() => { onSelectBoard(board.id); onClose(); }}
                                            className={`w-full text-left p-3 rounded-lg flex items-center gap-3 transition-all ${currentBoardId === board.id ? 'bg-neon-yellow/20 text-neon-yellow border border-neon-yellow/50' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}
                                        >
                                            <Users size={16} />
                                            <span className="font-bold truncate">{board.title}</span>
                                            <span className="ml-auto text-[10px] bg-neon-yellow/20 px-1 rounded text-neon-yellow">SHARED</span>
                                        </button>
                                    ))}
                                    {boards.filter(b => b.ownerId !== user.uid).length === 0 && (
                                        <p className="text-xs text-slate-600 px-2 italic">No tienes tableros compartidos.</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="absolute bottom-0 w-full p-4 border-t border-slate-800 bg-[#080c14]">
                            <CyberButton onClick={onCreateBoard} fullWidth className="mb-3 text-sm" variant="ghost">
                                <Plus size={16} /> NUEVO TABLERO
                            </CyberButton>
                            <div className="flex items-center gap-3 pt-3 border-t border-slate-800/50">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-neon-blue to-neon-purple overflow-hidden">
                                    {user.photoURL ? <img src={user.photoURL} className="w-full h-full" /> : null}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-xs text-white font-bold truncate">{user.displayName || 'Usuario'}</p>
                                    <p className="text-[10px] text-slate-500 truncate">{user.email}</p>
                                </div>
                                <button onClick={onLogout} className="text-slate-500 hover:text-neon-red"><LogOut size={18} /></button>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            if (!isFirebaseConfigured) return <ConfigErrorScreen type={configErrorType} />;

            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [boards, setBoards] = useState([]);
            const [currentBoardId, setCurrentBoardId] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [activeTask, setActiveTask] = useState(null);
            
            // UI States
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false);
            const [activeSlide, setActiveSlide] = useState(0);
            const [newTaskContent, setNewTaskContent] = useState('');
            const [newTaskQuadrant, setNewTaskQuadrant] = useState(QuadrantId.Do);
            const [isExpandedInput, setIsExpandedInput] = useState(false);

            // 1. Auth Listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            // 2. Boards Listener
            useEffect(() => {
                if (!user) { setBoards([]); return; }

                // Query boards where I am owner OR member
                const qOwned = query(collection(db, "boards"), where("ownerId", "==", user.uid));
                const qShared = query(collection(db, "boards"), where("memberIds", "array-contains", user.email));

                const unsubOwned = onSnapshot(qOwned, (snap) => {
                    const ownedBoards = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setBoards(prev => {
                        const others = prev.filter(b => b.ownerId !== user.uid);
                        const all = [...others, ...ownedBoards].sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        if (!currentBoardId && all.length > 0) setCurrentBoardId(all[0].id);
                        return all;
                    });
                });

                const unsubShared = onSnapshot(qShared, (snap) => {
                    const sharedBoards = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setBoards(prev => {
                        const mine = prev.filter(b => b.ownerId === user.uid);
                        return [...mine, ...sharedBoards].sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    });
                });

                return () => { unsubOwned(); unsubShared(); };
            }, [user]);

            // 3. Tasks Listener
            useEffect(() => {
                if (!user || !currentBoardId) { setTasks([]); return; }

                const q = query(collection(db, "boards", currentBoardId, "tasks"), orderBy("createdAt", "desc"));
                const unsubscribe = onSnapshot(q, (snap) => {
                    const loadedTasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setTasks(loadedTasks);
                });
                return unsubscribe;
            }, [currentBoardId, user]);

            // ACTIONS
            const handleLogin = async () => {
                try { 
                    await signInWithPopup(auth, new GoogleAuthProvider()); 
                } catch (e) { 
                    console.error(e); 
                    if (e.message.includes("malformed") || e.code === 'auth/unauthorized-domain') {
                         alert("⚠️ ERROR 400: Google bloqueó el inicio de sesión.\n\nSOLUCIÓN:\n1. Ve a Firebase Console > Authentication > Settings > Authorized Domains.\n2. Agrega '127.0.0.1' a la lista.\n3. Verifica que el 'authDomain' en tu código sea correcto.");
                    } else {
                         alert("Error login: " + e.message); 
                    }
                }
            };

            const handleLogout = () => {
                signOut(auth);
                setCurrentBoardId(null);
            };

            const handleCreateBoard = async (title) => {
                try {
                    const docRef = await addDoc(collection(db, "boards"), {
                        title,
                        ownerId: user.uid,
                        memberIds: [],
                        createdAt: serverTimestamp()
                    });
                    setCurrentBoardId(docRef.id);
                    setShowCreateModal(false);
                    setSidebarOpen(false);
                } catch (e) { alert("Error creating board: " + e.message); }
            };

            const handleShareBoard = async (email) => {
                if (!currentBoardId) return;
                try {
                    const boardRef = doc(db, "boards", currentBoardId);
                    await updateDoc(boardRef, {
                        memberIds: arrayUnion(email)
                    });
                    alert("Invitación enviada (acceso concedido)");
                    setShowShareModal(false);
                } catch (e) { alert("Error sharing: " + e.message); }
            };

            // --- TASK ACTIONS (FIRESTORE) ---
            const handleAddTask = async (e) => {
                e.preventDefault();
                if (!newTaskContent.trim() || !currentBoardId) return;
                try {
                    await addDoc(collection(db, "boards", currentBoardId, "tasks"), {
                        content: newTaskContent,
                        quadrant: newTaskQuadrant,
                        completed: false,
                        createdAt: Date.now() // Using client timestamp for simpler ordering in this demo
                    });
                    setNewTaskContent('');
                    setIsExpandedInput(false);
                } catch(e) { console.error(e); }
            };

            const handleToggleTask = async (id, currentStatus) => {
                 if(!currentBoardId) return;
                 await updateDoc(doc(db, "boards", currentBoardId, "tasks", id), { completed: currentStatus });
            };

            const handleDeleteTask = async (id) => {
                if(!currentBoardId) return;
                await deleteDoc(doc(db, "boards", currentBoardId, "tasks", id));
            };

            // --- DRAG AND DROP ---
            const sensors = useSensors(
                useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),
                useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
            );

            const handleDragStart = (event) => {
                const task = tasks.find(t => t.id === event.active.id);
                if (task) setActiveTask(task);
            };

            const handleDragEnd = async (event) => {
                const { active, over } = event;
                setActiveTask(null);
                
                if (!over || !currentBoardId) return;

                const activeId = active.id;
                const overId = over.id;
                
                // Identify target quadrant
                let targetQuadrant = null;
                const isContainer = Object.values(QuadrantId).includes(overId);
                
                if (isContainer) {
                    targetQuadrant = overId;
                } else {
                    const overTask = tasks.find(t => t.id === overId);
                    if (overTask) targetQuadrant = overTask.quadrant;
                }

                if (targetQuadrant) {
                    const activeTask = tasks.find(t => t.id === activeId);
                    if (activeTask && activeTask.quadrant !== targetQuadrant) {
                        // Move to new quadrant in Firestore
                        await updateDoc(doc(db, "boards", currentBoardId, "tasks", activeId), {
                            quadrant: targetQuadrant
                        });
                    }
                }
            };

            // --- CALCULATIONS ---
            const stats = useMemo(() => {
                return {
                    total: tasks.length,
                    completed: tasks.filter(t => t.completed).length,
                    urgent: tasks.filter(t => !t.completed && (t.quadrant === QuadrantId.Do || t.quadrant === QuadrantId.Delegate)).length,
                    important: tasks.filter(t => !t.completed && (t.quadrant === QuadrantId.Do || t.quadrant === QuadrantId.Plan)).length
                };
            }, [tasks]);

            const currentBoard = boards.find(b => b.id === currentBoardId);

            // --- RENDER ---
            if (loading) return <div className="min-h-screen bg-black flex items-center justify-center"><span className="loader"></span></div>;
            if (!user) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="min-h-screen bg-cyber text-slate-200 pb-24 flex flex-col">
                    <DndContext 
                        sensors={sensors} 
                        collisionDetection={pointerWithin} 
                        onDragStart={handleDragStart} 
                        onDragEnd={handleDragEnd}
                        autoScroll={{ threshold: { x: 0.15, y: 0.15 }, acceleration: 10, interval: 10 }}
                    >
                        {/* HEADER */}
                        <header className="pt-4 pb-2 px-4 border-b border-slate-800/60 bg-neon-dark/50 backdrop-blur-sm sticky top-0 z-30 flex items-center justify-between">
                             <button onClick={() => setSidebarOpen(true)} className="p-2 text-neon-blue hover:bg-white/5 rounded">
                                <Menu />
                             </button>
                             
                             <div className="text-center flex-1">
                                <h1 className="text-xl md:text-2xl font-saira font-black text-white truncate max-w-[200px] md:max-w-md mx-auto">
                                    {currentBoard ? currentBoard.title : "CARGANDO..."}
                                </h1>
                                {currentBoard && currentBoard.ownerId !== user.uid && (
                                    <span className="text-[10px] bg-neon-yellow/20 text-neon-yellow px-1 rounded">COMPARTIDO</span>
                                )}
                             </div>

                             <button onClick={() => setShowShareModal(true)} className="p-2 text-neon-yellow hover:bg-white/5 rounded">
                                <Share2 />
                             </button>
                        </header>
                        
                        <InstallPrompt />

                        <Sidebar 
                            isOpen={sidebarOpen} 
                            onClose={() => setSidebarOpen(false)} 
                            user={user}
                            boards={boards}
                            currentBoardId={currentBoardId}
                            onSelectBoard={setCurrentBoardId}
                            onCreateBoard={() => setShowCreateModal(true)}
                            onLogout={handleLogout}
                        />

                        {/* TASK INPUT */}
                        <div className="mt-6 px-4 w-full max-w-md mx-auto z-20 relative">
                             <div className={`bg-neon-panel border border-neon-blue/30 p-4 transition-all duration-300 ${isExpandedInput ? 'shadow-neon-blue' : ''}`}>
                                <form onSubmit={handleAddTask} className="flex flex-col gap-3">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newTaskContent}
                                            onChange={(e) => { setNewTaskContent(e.target.value); setIsExpandedInput(true); }}
                                            onFocus={() => setIsExpandedInput(true)}
                                            placeholder="NUEVA TAREA..."
                                            className="flex-1 bg-neon-dark border-b-2 border-neon-blue/50 text-white font-saira font-semibold px-3 py-2 focus:outline-none focus:border-neon-blue placeholder-slate-600"
                                        />
                                        <CyberButton type="submit" disabled={!newTaskContent.trim()} className={!isExpandedInput ? "opacity-50" : "opacity-100"}>
                                            <Plus size={20} />
                                        </CyberButton>
                                    </div>
                                    {isExpandedInput && (
                                        <div className="grid grid-cols-4 gap-2 mt-2 animate-fade-in-down">
                                            {QUADRANTS.map((quad) => (
                                                <button
                                                    key={quad.id}
                                                    type="button"
                                                    onClick={() => setNewTaskQuadrant(quad.id)}
                                                    className={`flex flex-col items-center justify-center p-2 border transition-all duration-200 ${newTaskQuadrant === quad.id ? `${quad.borderColor} ${quad.color.replace('bg-', 'bg-').replace('text-', 'text-')} bg-opacity-20 text-white shadow-[0_0_10px_rgba(0,0,0,0.5)]` : 'border-slate-700 text-slate-500 hover:border-slate-500'}`}
                                                >
                                                    <div className={newTaskQuadrant === quad.id ? quad.textColor : ''}><quad.Icon className="w-4 h-4" /></div>
                                                    <span className="text-[0.6rem] font-bold mt-1 uppercase">{quad.id}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </form>
                             </div>
                        </div>

                        {/* QUADRANTS */}
                        <main className="flex-1 px-0 md:px-4 max-w-7xl mx-auto w-full pb-4 mt-6 overflow-hidden">
                            <div className={`flex md:grid md:grid-cols-2 flex-nowrap md:flex-wrap overflow-x-auto md:overflow-visible ${activeTask ? '' : 'snap-x snap-mandatory'} md:gap-6 pb-8 md:pb-0 hide-scrollbar w-full`}>
                                {QUADRANTS.map((q, idx) => (
                                    <div key={q.id} className="min-w-[100vw] md:min-w-0 snap-center flex flex-col h-[60vh] md:h-[600px] px-4 md:px-0">
                                        <QuadrantList 
                                            id={q.id} 
                                            tasks={tasks} 
                                            onToggle={(tid, status) => handleToggleTask(tid, status)} 
                                            onDelete={handleDeleteTask} 
                                        />
                                    </div>
                                ))}
                            </div>
                            {/* Mobile Dots */}
                            <div className="flex md:hidden justify-center gap-3 mt-2">
                                {QUADRANTS.map((_, idx) => (
                                <div key={idx} className={`w-2 h-2 rounded-full transition-all duration-300 ${idx === activeSlide ? 'bg-neon-blue w-6' : 'bg-slate-700'}`} />
                                ))}
                            </div>
                        </main>

                        {/* STATS */}
                        <div className="fixed bottom-0 left-0 right-0 bg-neon-panel border-t border-slate-800 backdrop-blur-md p-4 pb-6 md:pb-4 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
                            <div className="max-w-4xl mx-auto grid grid-cols-4 gap-2 md:gap-8">
                                <div className="flex flex-col items-center justify-center">
                                    <div className="flex items-center gap-1 mb-1 text-neon-blue"><Activity size={16} /><span className="font-saira font-bold text-xl tabular-nums">{stats.total}</span></div>
                                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">TOTAL</span>
                                </div>
                                <div className="flex flex-col items-center justify-center">
                                    <div className="flex items-center gap-1 mb-1 text-neon-red"><AlertTriangle size={16} /><span className="font-saira font-bold text-xl tabular-nums">{stats.urgent}</span></div>
                                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">URGENTE</span>
                                </div>
                                <div className="flex flex-col items-center justify-center">
                                    <div className="flex items-center gap-1 mb-1 text-neon-yellow"><Star size={16} /><span className="font-saira font-bold text-xl tabular-nums">{stats.important}</span></div>
                                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">IMPORTANTE</span>
                                </div>
                                <div className="flex flex-col items-center justify-center">
                                    <div className="flex items-center gap-1 mb-1 text-neon-green"><CheckCircle2 size={16} /><span className="font-saira font-bold text-xl tabular-nums">{stats.completed}</span></div>
                                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">HECHO</span>
                                </div>
                            </div>
                        </div>

                        <DragOverlay>
                            {activeTask ? <TaskCard task={activeTask} onToggle={()=>{}} onDelete={()=>{}} isOverlay /> : null}
                        </DragOverlay>

                        {/* MODALS */}
                        {showCreateModal && <CreateBoardModal onClose={() => setShowCreateModal(false)} onCreate={handleCreateBoard} />}
                        {showShareModal && currentBoard && <ShareBoardModal onClose={() => setShowShareModal(false)} onShare={handleShareBoard} currentMembers={currentBoard.memberIds} />}

                    </DndContext>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
